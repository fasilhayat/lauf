name: .NET lauf CD

on:
  workflow_run:
    workflows: [".NET lauf Build"]
    types:
      - completed

jobs:
  push-packages:
    runs-on: [self-hosted, lauf]
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Locate CI artifacts
        run: |
          ARTIFACTS_DIR="$HOME/actions-runner-lauf/artifacts"
          echo "Artifacts folder: $ARTIFACTS_DIR"
          ls -lh "$ARTIFACTS_DIR"

      - name: Determine packages to push
        run: |
          ARTIFACTS_DIR="$HOME/actions-runner-lauf/artifacts"
          echo "Determining which packages need to be pushed..."
          > packages_to_push.txt  # clear file first

          for pkg in "$ARTIFACTS_DIR"/*.nupkg; do
            [ ! -f "$pkg" ] && continue   # skip if no file found
            FILE_NAME=$(basename "$pkg")
            PKG_NAME=$(echo "$FILE_NAME" | cut -d. -f1)
            PKG_VERSION=$(echo "$FILE_NAME" | sed -E 's/.*\.([0-9]+\.[0-9]+\.[0-9]+(-[a-z0-9.]+)?)\.nupkg/\1/')

            # Check if package version exists in Baget
            if ! curl -s -f "https://nuget.hayatnet.local/v3/flatcontainer/$PKG_NAME/index.json" | grep -q "$PKG_VERSION"; then
              echo "Will push: $FILE_NAME"
              echo "$pkg" >> packages_to_push.txt
            else
              echo "Skipping existing package: $FILE_NAME"
            fi
          done

          echo "Packages to push:"
          cat packages_to_push.txt

      - name: Push NuGet packages to nuget.hayatnet.local
        run: |
          while read -r pkg; do
            [ -z "$pkg" ] && continue
            echo "Pushing $pkg to Baget..."
            dotnet nuget push "$pkg" \
              --source "https://nuget.hayatnet.local/v3/index.json" \
              --api-key "${{ secrets.BAGET_API_KEY }}" \
              --skip-duplicate
          done < packages_to_push.txt
